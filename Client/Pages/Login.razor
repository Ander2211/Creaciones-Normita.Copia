@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using Shared.Models
@inject HttpClient Http
@inject NavigationManager NavigationManager
@using Client.Components;
@using Client.Services
@inject ToastService ToastService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject AuthService AuthService


<div class="relative min-h-screen flex items-center justify-center overflow-hidden">
    <!-- Video de fondo -->
    <video autoplay loop muted playsinline class="absolute w-full h-full object-cover">
        <source src="media/LoginVideo.webm" type="video/webm" />
        Tu navegador no soporta la reproducción de video.
    </video>

    <!-- Overlay semi-transparente con blur -->
    <div class="absolute inset-0 bg-black bg-opacity-30 backdrop-blur-sm"></div>

    <!-- Contenedor del login -->
    <div class="relative w-full max-w-sm bg-white bg-opacity-60 rounded-xl shadow-lg p-10 flex flex-col justify-center">
        <h3 class="text-3xl font-bold mb-6 text-center text-gray-800">Iniciar Sesión</h3>

        <EditForm Model="@loginRequest" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Usuario</label>
                <InputText @bind-Value="loginRequest.UserName"
                           type="text"
                           class="w-full rounded-md border border-gray-300 shadow-sm px-4 py-3 focus:ring-purple-500 focus:border-purple-500 text-gray-700" />
                <ValidationMessage For="@(() => loginRequest.UserName)" class="text-red-600 text-sm mt-1" />
            </div>

            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                <InputText @bind-Value="loginRequest.Password"
                           type="password"
                           class="w-full rounded-md border border-gray-300 shadow-sm px-4 py-3 focus:ring-purple-500 focus:border-purple-500 text-gray-700" />
                <ValidationMessage For="@(() => loginRequest.Password)" class="text-red-600 text-sm mt-1" />
            </div>

            <button type="submit"
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg shadow-md transition-colors duration-200"
                    disabled="@isLoading">
                @(isLoading ? "Entrando..." : "Entrar")
            </button>
        </EditForm>
    </div>
</div>

@code {
    private LoginRequest loginRequest = new();
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User?.Identity?.IsAuthenticated == true)
        {
            // si ya está autenticado, no necesita ver /login
            NavigationManager.NavigateTo("/", false);
        }
    }

    private async Task HandleLogin()
    {
        isLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(loginRequest);

            if (response.IsSuccessStatusCode)
            {
                if (AuthenticationStateProvider is CustomAuthStateProvider customAuth)
                {
                    customAuth.NotifyUserAuthentication(loginRequest.UserName);
                }

                await ToastService.ShowToast("Inicio de sesión exitoso", "success");
                NavigationManager.NavigateTo("/", forceLoad: true);
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                await ToastService.ShowToast("Usuario o contraseña incorrecta", "error");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.ServiceUnavailable)
            {
                await ToastService.ShowToast("Error de conexión al servidor", "error");
            }
            else
            {
                // Intenta leer el mensaje de error controlado del backend
                var error = await response.Content.ReadAsStringAsync();
                // Si el mensaje es muy largo o parece un stacktrace, muestra un mensaje genérico
                if (string.IsNullOrWhiteSpace(error) || error.Length > 200 || error.Contains("Exception"))
                {
                    await ToastService.ShowToast("Ha ocurrido un error inesperado", "error");
                }
                else
                {
                    await ToastService.ShowToast(error, "error");
                }
            }
        }
        catch (HttpRequestException)
        {
            await ToastService.ShowToast("Error de conexión al servidor", "error");
        }
        catch (Exception)
        {
            await ToastService.ShowToast("Ha ocurrido un error inesperado", "error");
        }
        finally
        {
            isLoading = false;
        }
    }

}